import{r as w,j as l,o as I,B as Y}from"./index-DiaJK5at.js";import{c as O}from"./createLucideIcon-Sqi4i3ov.js";/**
 * @license lucide-react v0.503.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],B=O("arrow-right",X);/**
 * @license lucide-react v0.503.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=[["path",{d:"M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z",key:"1wis1t"}],["path",{d:"M14 3v4a2 2 0 0 0 2 2h4",key:"36rjfy"}],["path",{d:"M8 13h.01",key:"1sbv64"}],["path",{d:"M16 13h.01",key:"wip0gl"}],["path",{d:"M10 16s.8 1 2 1c1.3 0 2-1 2-1",key:"1vvgv3"}]],_=O("sticker",S);function F(){const[e,o]=w.useState([{id:"1",type:"sticker",text:"Hello 1",x:100,y:100},{id:"2",type:"sticker",text:"Hello 2",x:200,y:200},{id:"3",type:"arrow",start:{x:10,y:10,relativeTo:"1"},end:{x:20,y:20,relativeTo:"2"}}]);return{nodes:e,addArrow:i=>{o(u=>[...u,{...i,id:crypto.randomUUID(),type:"arrow"}])},addSticker:i=>{o(u=>[...u,{id:crypto.randomUUID(),type:"sticker",...i}])},updateStickerText:(i,u)=>{o(a=>a.map(d=>d.id===i?{...d,text:u}:d))},updateNodesPositions:i=>{const u=Object.fromEntries(i.map(a=>[`${a.id}${a.type??""}`,a]));o(a=>a.map(d=>{if(d.type==="arrow"){const f=u[`${d.id}start`],h=u[`${d.id}end`];return{...d,start:(f==null?void 0:f.point)??d.start,end:(h==null?void 0:h.point)??d.end}}if(d.type==="sticker"){const f=u[d.id];if(f)return{...d,...f.point}}return d}))},deleteNodes:i=>{o(u=>{const a=u.filter(d=>d.type==="arrow"&&d.start.relativeTo&&i.includes(d.start.relativeTo)||d.type==="arrow"&&d.end.relativeTo&&i.includes(d.end.relativeTo)).map(d=>d.id);return u.filter(d=>!i.includes(d.id)&&!a.includes(d.id))})}}}const H=()=>{const[e,o]=w.useState();return{canvasRef:w.useCallback(t=>{const s=new ResizeObserver(r=>{for(const c of r){const{width:i,height:u}=c.contentRect,{x:a,y:d}=c.target.getBoundingClientRect();o({x:a,y:d,width:i,height:u})}});return t?(s.observe(t),()=>{s.disconnect()}):()=>{}},[]),canvasRect:e}};function G(){const e=w.useRef(null);return w.useEffect(()=>{e.current&&e.current.focus();const o=()=>{var n;document.visibilityState==="visible"&&((n=e.current)==null||n.focus())};return window.addEventListener("visibilitychange",o),()=>{window.removeEventListener("visibilitychange",o)}},[e]),e}function p(e,o,n){return n?{x:(e.x-n.x)/o.zoom+o.x,y:(e.y-n.y)/o.zoom+o.y}:e}function b(e,o,n){if(n==="replace")return new Set(o);if(n==="add")return new Set([...e,...o]);if(n==="toggle"){const t=new Set(e),s=new Set(o),r=Array.from(e).filter(i=>!s.has(i)),c=o.filter(i=>!t.has(i));return new Set([...r,...c])}return e}function V({setViewState:e}){const o=(r,c,i)=>{e({...r,selectedIds:b(r.selectedIds,c,i)})};return{isSelected:(r,c)=>r.selectedIds.has(c),handleNodeClick:(r,c,i)=>{i.ctrlKey||i.shiftKey?o(r,[c],"toggle"):o(r,[c],"replace")},handleOverlayMouseUp:r=>{r.mouseDown&&e({...r,selectedIds:b(r.selectedIds,[],"replace")})}}}function Z({nodesModel:e,setViewState:o}){const n=s=>{if(s.selectedIds.size>0){const r=Array.from(s.selectedIds);e.deleteNodes(r),o({...s,selectedIds:new Set})}};return{handleKeyDown:(s,r)=>{(r.key==="Delete"||r.key==="Backspace")&&n(s)}}}function q({nodesModel:e,setViewState:o}){return n=>({nodes:e.nodes.map(t=>t.id===n.stickerId&&t.type==="sticker"?{...t,isSelected:!0,isEditing:!0,text:n.newText??t.text,onTextChange:s=>{o({...n,newText:s})}}:t),layout:{onKeyDown:t=>{t.key==="Escape"&&(n.newText&&e.updateStickerText(n.stickerId,n.newText),o(x()))}},overlay:{onClick:()=>{n.newText&&e.updateStickerText(n.stickerId,n.newText),o(x())}}})}function J(e){return{type:"edit-sticker",stickerId:e}}function Q(e){const{setViewState:o}=e;return{handleNodeClick:(t,s,r)=>t.selectedIds.size===1&&t.selectedIds.has(s)&&!r.ctrlKey&&!r.shiftKey?(o(J(s)),{preventNext:!0}):{preventNext:!1}}}function ee({setViewState:e,canvasRect:o,windowPositionModel:n}){return{handleOverlayMouseDown:(i,u)=>{const a=p({x:u.clientX,y:u.clientY},n.position,o);e({...i,mouseDown:{type:"overlay",x:a.x,y:a.y,isRigthClick:u.button===2}})},handleWindowMouseUp:i=>{i.mouseDown&&e({...i,mouseDown:void 0})},handleNodeMouseDown:(i,u,a)=>{const d=p({x:a.clientX,y:a.clientY},n.position,o);e({...i,mouseDown:{type:"node",x:d.x,y:d.y,nodeId:u,isRigthClick:a.button===2}})},getIsStickerMouseDown:(i,u)=>{var a;return((a=i.mouseDown)==null?void 0:a.type)==="node"&&i.mouseDown.nodeId===u}}}function g(e,o){return{x:o.x-e.x,y:o.y-e.y}}function N(e,o){return Math.sqrt((o.x-e.x)**2+(o.y-e.y)**2)}function k(e,o){return{x:e.x+o.x,y:e.y+o.y}}function M(e,o){let n=o.relativeTo,t=o;for(;n;){const s=e[n];s&&(t=k(t,s)),n=s==null?void 0:s.relativeTo}return t}function D(e){return"relativeTo"in e}function oe(e,o){return{x:e.x,y:e.y,width:o.width,height:o.height}}function E(e,o){return{x:Math.min(e.x,o.x),y:Math.min(e.y,o.y),width:Math.abs(e.x-o.x),height:Math.abs(e.y-o.y)}}function ne(e,o){return e.x<=o.x+o.width&&e.x+e.width>=o.x&&e.y<=o.y+o.height&&e.y+e.height>=o.y}function T(e){return Object.fromEntries(e.filter(n=>n.type==="sticker").map(n=>[n.id,n]))}function te(e,o){return e.map(n=>{let t=n;return t.type==="arrow"&&D(t.start)&&(t={...t,start:M(o,t.start)}),t.type==="arrow"&&D(t.end)&&(t={...t,end:M(o,t.end)}),t})}function se(e){const o=w.useMemo(()=>{const n=T(e.nodes);return te(e.nodes,n)},[e.nodes]);return{...e,nodes:o}}function re({nodesModel:e,canvasRect:o,setViewState:n,nodesDimensions:t,windowPositionModel:s}){const r=(c,i)=>{const u=T(e.nodes);return e.nodes.map(a=>{const d=t[a.id],f=a.type==="sticker"?oe(a,d):E(M(u,a.start),M(u,a.end));return{...a,isSelected:ne(f,i)||c.initialSelectedIds.has(a.id)}})};return c=>{const i=E(c.startPoint,c.endPoint),u=r(c,i);return{nodes:u,selectionWindow:i,window:{onMouseMove:a=>{const d=p({x:a.clientX,y:a.clientY},s.position,o);n({...c,endPoint:d})},onMouseUp:()=>{const a=u.filter(d=>d.isSelected).map(d=>d.id);n(x({selectedIds:b(c.initialSelectedIds,a,"add")}))}}}}}function ie({startPoint:e,endPoint:o,initialSelectedIds:n}){return{type:"selection-window",startPoint:e,endPoint:o,initialSelectedIds:n??new Set}}function ce({setViewState:e,canvasRect:o,windowPositionModel:n}){return{handleIdleWindowMouseMove:(s,r)=>{if(s.mouseDown&&s.mouseDown.type==="overlay"&&!s.mouseDown.isRigthClick){const c=p({x:r.clientX,y:r.clientY},n.position,o);N(s.mouseDown,c)>5&&e(ie({startPoint:s.mouseDown,endPoint:c,initialSelectedIds:r.shiftKey?s.selectedIds:void 0}))}}}}function ue({nodesModel:e,canvasRect:o,setViewState:n,windowPositionModel:t}){const s=r=>e.nodes.map(c=>{if(r.nodesToMove.has(c.id)){const i=g(r.startPoint,r.endPoint);return c.type==="arrow"?{...c,start:D(c.start)?c.start:k(c.start,i),end:D(c.end)?c.end:k(c.end,i),isSelected:!0}:{...c,...k(c,i),isSelected:!0}}return c});return r=>{const c=s(r);return{nodes:c,window:{onMouseMove:i=>{const u=p({x:i.clientX,y:i.clientY},t.position,o);n({...r,endPoint:u})},onMouseUp:()=>{const i=c.filter(u=>r.nodesToMove.has(u.id)).flatMap(u=>u.type==="arrow"?[{id:u.id,point:u.start,type:"start"},{id:u.id,point:u.end,type:"end"}]:[{id:u.id,point:{x:u.x,y:u.y}}]);e.updateNodesPositions(i),n(x({selectedIds:r.nodesToMove}))}}}}}function ae({startPoint:e,endPoint:o,nodesToMove:n}){return{type:"nodes-dragging",startPoint:e,endPoint:o,nodesToMove:n}}function de({canvasRect:e,setViewState:o,windowPositionModel:n}){return{handleIdleWindowMouseMove:(s,r)=>{if(s.mouseDown&&s.mouseDown.type==="node"&&!s.mouseDown.isRigthClick){const c=p({x:r.clientX,y:r.clientY},n.position,e);N(s.mouseDown,c)>5&&o(ae({startPoint:s.mouseDown,endPoint:c,nodesToMove:new Set([...s.selectedIds,s.mouseDown.nodeId])}))}}}}function le({nodesModel:e,canvasRect:o,setViewState:n,windowPositionModel:t}){return s=>{const r=g(s.startPoint,s.endPoint);return{nodes:e.nodes,windowPosition:{x:t.position.x-r.x,y:t.position.y-r.y,zoom:t.position.zoom},window:{onMouseMove:c=>{const i=p({x:c.clientX,y:c.clientY},t.position,o);n({...s,endPoint:i})},onMouseUp:()=>{t.setPosition({x:t.position.x-r.x,y:t.position.y-r.y,zoom:t.position.zoom}),n(x({}))}}}}}function fe({startPoint:e,endPoint:o}){return{type:"window-dragging",startPoint:e,endPoint:o}}function ye({canvasRect:e,setViewState:o,windowPositionModel:n}){return{handleIdleWindowMouseMove:(s,r)=>{if(s.mouseDown&&s.mouseDown.isRigthClick){const c=p({x:r.clientX,y:r.clientY},n.position,e);N(s.mouseDown,c)>5&&o(fe({startPoint:s.mouseDown,endPoint:c}))}}}}function we(e){const{nodesModel:o}=e,n=Z(e),t=Q(e),s=ce(e),r=de(e),c=ye(e),i=V(e),u=ee(e);return a=>({nodes:o.nodes.map(d=>({...d,isSelected:i.isSelected(a,d.id),onMouseDown:f=>u.handleNodeMouseDown(a,d.id,f),onMouseUp:f=>{!u.getIsStickerMouseDown(a,d.id)||t.handleNodeClick(a,d.id,f).preventNext||i.handleNodeClick(a,d.id,f)}})),layout:{onKeyDown:d=>{n.handleKeyDown(a,d)}},overlay:{onMouseDown:d=>u.handleOverlayMouseDown(a,d),onMouseUp:()=>i.handleOverlayMouseUp(a)},window:{onMouseMove:d=>{r.handleIdleWindowMouseMove(a,d),s.handleIdleWindowMouseMove(a,d),c.handleIdleWindowMouseMove(a,d)},onMouseUp:()=>u.handleWindowMouseUp(a)}})}function x({selectedIds:e}={}){return{type:"idle",selectedIds:e??new Set}}function pe({nodesModel:e,canvasRect:o,setViewState:n,windowPositionModel:t}){return()=>({nodes:e.nodes,layout:{onKeyDown:s=>{s.key==="Escape"&&n(x())}},canvas:{onClick:s=>{if(!o)return;const r=p({x:s.clientX,y:s.clientY},t.position,o);e.addSticker({text:"Default",x:r.x,y:r.y}),n(x())}},actions:{addSticker:{isActive:!0,onClick:()=>n(x())}}})}function $(){return{type:"add-sticker"}}function xe({windowPositionModel:e,canvasRect:o}){return n=>({...n,window:{...n.window,onMouseWheel:t=>{var a,d;(d=(a=n.window)==null?void 0:a.onMouseWheel)==null||d.call(a,t);const s=t.deltaY>0?.9:1.1,r=p({x:t.clientX,y:t.clientY},e.position,o),c=e.position.zoom*s,i=p({x:t.clientX,y:t.clientY},{...e.position,zoom:c},o),u=g(r,i);e.setPosition({x:e.position.x-u.x,y:e.position.y-u.y,zoom:c})}}})}function he({nodesModel:e,setViewState:o,windowPositionModel:n,canvasRect:t}){const s=(r,c)=>{const i=T(e.nodes),u={start:r.startRelativeTo?{...g(i[r.startRelativeTo],r.startPoint),relativeTo:r.startRelativeTo}:r.startPoint,end:c?{...g(i[c],r.endPoint),relativeTo:c}:r.endPoint};e.addArrow(u)};return r=>{const c={id:"drawing-arrow",type:"arrow",start:r.startPoint,end:r.endPoint,noPointerEvents:!0};return{nodes:[...e.nodes,c].map(u=>u.type==="sticker"?{...u,onMouseUp:()=>{s(r,u.id)}}:u),layout:{onKeyDown:u=>{u.key==="Escape"&&o(x())}},overlay:{onMouseUp:()=>{s(r)}},window:{onMouseMove:u=>{const a=p({x:u.clientX,y:u.clientY},n.position,t);o({...r,endPoint:a})},onMouseUp:()=>{o(x())}},actions:{addArrow:{isActive:!0}}}}}function L(e,o){return{type:"draw-arrow",startPoint:e,endPoint:e,startRelativeTo:o}}function ve({nodesModel:e,setViewState:o,windowPositionModel:n,canvasRect:t}){return()=>({nodes:e.nodes.map(s=>s.type==="sticker"?{...s,onMouseDown:r=>{const c=p({x:r.clientX,y:r.clientY},n.position,t);o(L(c,s.id))}}:s),layout:{onKeyDown:s=>{s.key==="Escape"&&o(x())}},overlay:{onMouseDown:s=>o(L(p({x:s.clientX,y:s.clientY},n.position,t)))},actions:{addArrow:{isActive:!0,onClick:()=>o(x())}}})}function U(){return{type:"add-arrow"}}function me({setViewState:e}){return o=>({...o,layout:{...o.layout,onKeyDown:n=>{var t,s;(s=(t=o.layout)==null?void 0:t.onKeyDown)==null||s.call(t,n),n.key==="s"&&e($()),n.key==="a"&&e(U())}},actions:{addArrow:{isActive:!1,onClick:()=>e(U())},addSticker:{isActive:!1,onClick:()=>e($())},...o.actions}})}function ge(e){const[o,n]=w.useState(()=>x()),t={...e,setViewState:n},s=ve(t),r=he(t),c=pe(t),i=q(t),u=we(t),a=re(t),d=ue(t),f=le(t),h=xe(t),v=me(t);let y;switch(o.type){case"idle":{y=u(o),y=v(y);break}case"add-arrow":{y=s(),y=v(y);break}case"add-sticker":{y=c(),y=v(y);break}case"draw-arrow":{y=r(o);break}case"edit-sticker":{y=i(o);break}case"selection-window":{y=a(o);break}case"nodes-dragging":{y=d(o);break}case"window-dragging":{y=f(o);break}default:throw new Error("Invalid view state")}return y=h(y),y=se(y),y}function ke(e){const o=w.useRef(e);w.useLayoutEffect(()=>{o.current=e},[e]),w.useEffect(()=>{const n=r=>{var c,i;(i=(c=o.current.window)==null?void 0:c.onMouseMove)==null||i.call(c,r)},t=r=>{var c,i;(i=(c=o.current.window)==null?void 0:c.onMouseUp)==null||i.call(c,r)},s=r=>{var c,i;(i=(c=o.current.window)==null?void 0:c.onMouseWheel)==null||i.call(c,r)};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",t),window.addEventListener("wheel",s),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",t),window.removeEventListener("wheel",s)}},[o])}function Me({children:e}){return l.jsx("div",{className:"absolute left-4 top-1/2 -translate-y-1/2 flex flex-col gap-2 bg-white p-1 rounded-md shadow",children:e})}function De({children:e,ref:o,...n}){return l.jsx("div",{className:"grow relative",tabIndex:0,ref:o,...n,children:e})}function be({windowPosition:e}){return l.jsx("div",{style:{"--zoom":e.zoom,"--x":-e.x*e.zoom+"px","--y":-e.y*e.zoom+"px"},className:`
        absolute inset-0
        bg-[radial-gradient(#e5e7eb_calc(1px*var(--zoom)),transparent_calc(1px*var(--zoom)))]
        [background-position:var(--x)_var(--y)]
        [background-size:calc(16px*var(--zoom))_calc(16px*var(--zoom))]
        `})}function Ie({children:e,windowPosition:o,ref:n,overlay:t,...s}){return l.jsxs("div",{ref:n,...s,onContextMenu:r=>r.preventDefault(),className:"absolute inset-0 select-none overflow-hidden",children:[t,l.jsx("div",{style:{transformOrigin:"left top",transform:`scale(${o.zoom}) translate(${-o.x}px, ${-o.y}px)`},children:e})]})}function Ne({onClick:e,onMouseDown:o,onMouseUp:n}){return l.jsx("div",{className:"absolute inset-0",onClick:e,onMouseDown:o,onMouseUp:n})}function Te({id:e,text:o,x:n,y:t,onClick:s,ref:r,isSelected:c,isEditing:i,onTextChange:u,onMouseDown:a,onMouseUp:d}){return l.jsx("button",{"data-id":e,ref:r,className:I("absolute bg-yellow-300 px-2 py-4 rounded-xs shadow-md text-left",c&&"outline-2 outline-blue-500"),style:{transform:`translate(${n}px, ${t}px)`},onClick:s,onMouseDown:a,onMouseUp:d,children:l.jsx(Ae,{isEditing:i??!1,value:o,onChange:f=>u==null?void 0:u(f)})})}function Ae({value:e,onChange:o,isEditing:n}){const t=w.useRef(null),[s,r]=w.useState(0),[c,i]=w.useState(0);return w.useLayoutEffect(()=>{if(!t.current)return;const{clientHeight:u,scrollWidth:a}=t.current;r(u),i(a)},[e]),l.jsxs("div",{className:"relative",children:[l.jsx("div",{ref:t,className:I("whitespace-pre-wrap",n&&"opacity-0"),children:e}),n&&l.jsx("textarea",{autoFocus:!0,className:"absolute left-0 top-0 resize-none overflow-hidden focus:outline-none",value:e,onChange:u=>o==null?void 0:o(u.target.value),style:{height:s+2,width:c+2}})]})}function Re({x:e,y:o,height:n,width:t}){return l.jsx("div",{className:"absolute inset-0 bg-blue-500/30 border border-blue-500",style:{transform:`translate(${e}px, ${o}px)`,height:n,width:t}})}function K({children:e,isActive:o,onClick:n}){return l.jsx(Y,{variant:"ghost",size:"icon",className:o?"bg-blue-500/30 hover:bg-blue-600/30 text-blue-500 hover:text-blue-600":"",onClick:n,children:e})}const ze=()=>{const[e,o]=w.useState({}),n=w.useRef(void 0),t=w.useCallback(s=>{n.current||(n.current=new ResizeObserver(c=>{const i=Object.fromEntries(c.map(u=>[u.target.dataset.id,{width:u.borderBoxSize[0].inlineSize,height:u.borderBoxSize[0].blockSize}]).filter(u=>!!u[0]));o(u=>({...u,...i}))}));const r=n.current;if(s)return r.observe(s),()=>{o(c=>{const i={...c};return delete i[s.dataset.id??""],i}),r.unobserve(s)}},[]);return w.useEffect(()=>()=>{n.current&&n.current.disconnect()},[]),{nodeRef:t,nodesDimensions:e}};function je(){const[e,o]=w.useState({x:0,y:0,zoom:1});return{position:e,setPosition:o}}function We({start:e,end:o,ref:n,onClick:t,onMouseDown:s,onMouseUp:r,isSelected:c,noPointerEvents:i}){const u=g(e,o),a=Math.atan2(u.y,u.x),d=a+Math.PI*(1-1/6),f=a-Math.PI*(1-1/6),h=[Math.cos(d)*10,Math.sin(d)*10],v=[Math.cos(f)*10,Math.sin(f)*10];return l.jsx("svg",{className:"absolute left-0 top-0 pointer-events-none overflow-visible",children:l.jsx("path",{className:I(i?"pointer-events-none":"pointer-events-auto",c&&"stroke-blue-500 stroke-2 fill-blue-500"),stroke:"black",ref:n,strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",onClick:t,onMouseDown:s,onMouseUp:r,d:`
                    M ${e.x} ${e.y} L ${o.x} ${o.y}
                    M ${o.x} ${o.y} L ${o.x+h[0]} ${o.y+h[1]} L ${o.x+-5*Math.cos(a)} ${o.y+-5*Math.sin(a)}
                    L ${o.x+v[0]} ${o.y+v[1]} 
                    L ${o.x} ${o.y}
                   `})})}function Ce(){var a,d,f,h,v,y,A,R,z,j,W,C,P;const e=F(),o=je(),n=G(),{canvasRef:t,canvasRect:s}=H(),{nodeRef:r,nodesDimensions:c}=ze(),i=ge({nodesModel:e,canvasRect:s,nodesDimensions:c,windowPositionModel:o});ke(i);const u=i.windowPosition??o.position;return l.jsxs(De,{ref:n,onKeyDown:(a=i.layout)==null?void 0:a.onKeyDown,children:[l.jsx(be,{windowPosition:u}),l.jsxs(Ie,{ref:t,onClick:(d=i.canvas)==null?void 0:d.onClick,overlay:l.jsx(Ne,{onClick:(f=i.overlay)==null?void 0:f.onClick,onMouseDown:(h=i.overlay)==null?void 0:h.onMouseDown,onMouseUp:(v=i.overlay)==null?void 0:v.onMouseUp}),windowPosition:u,children:[i.nodes.map(m=>{if(m.type==="sticker")return l.jsx(Te,{...m,ref:r},m.id);if(m.type==="arrow")return l.jsx(We,{...m,ref:r},m.id)}),i.selectionWindow&&l.jsx(Re,{...i.selectionWindow})]}),l.jsxs(Me,{children:[l.jsx(K,{isActive:(A=(y=i.actions)==null?void 0:y.addSticker)==null?void 0:A.isActive,onClick:(z=(R=i.actions)==null?void 0:R.addSticker)==null?void 0:z.onClick,children:l.jsx(_,{})}),l.jsx(K,{isActive:(W=(j=i.actions)==null?void 0:j.addArrow)==null?void 0:W.isActive,onClick:(P=(C=i.actions)==null?void 0:C.addArrow)==null?void 0:P.onClick,children:l.jsx(B,{})})]})]})}const $e=Ce;export{$e as Component};
